<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ophthalmologist Directory</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
        }
        
        .search-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .city-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .city-selector label {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        
        .city-selector select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .city-selector select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
        }
        
        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-section {
            display: none;
        }
        
        .results-header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .results-header h2 {
            color: #333;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .data-source {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .data-source.api {
            background: #e8f5e8;
            color: #2d5a2d;
            border: 1px solid #4caf50;
        }
        
        .data-source.sample {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .doctors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .doctor-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .doctor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .doctor-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .doctor-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }
        
        .doctor-name-section {
            flex: 1;
        }
        
        .doctor-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .doctor-rating {
            font-size: 0.9rem;
            color: #666;
            font-weight: normal;
        }
        
        .profile-link {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .profile-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .doctor-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }
        
        .info-icon {
            font-size: 1.2rem;
            width: 25px;
            flex-shrink: 0;
        }
        
        .info-text {
            color: #555;
            line-height: 1.5;
        }
        
        .specialty {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 5px;
        }
        
        .available-time {
            background: #e8f5e8;
            color: #2d5a2d;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            border-left: 3px solid #4caf50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            color: #666;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .doctors-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <header class="header">
    <h1>دایرکتوری چشم‌پزشکان</h1>
    <p>بهترین متخصصان چشم‌پزشکی را در شهر خود پیدا کنید</p>
   </header>
   <div class="search-section">
    <div class="city-selector"><label for="citySelect">شهر مورد نظر:</label> <select id="citySelect"> <option value="mashhad" selected>مشهد (فعال)</option> </select> <button class="search-btn" onclick="searchDoctors()" id="searchBtn">جستجوی چشم‌پزشکان مشهد</button>
    </div>
   </div>
   <div id="resultsSection" class="results-section">
    <div class="results-header">
     <h2 id="resultsTitle">نتایج جستجو</h2>
    </div>
    <div id="dataSource" class="data-source"></div>
    <div id="doctorsContainer" class="doctors-grid"></div>
   </div>
  </div>
  <script>
        // Browse.ai configuration
        const BROWSE_AI_CONFIG = {
            apiKey: "0fbe38cd-ab85-49d9-a1a3-51e9870a9457:ef34b9d7-06b6-4287-ba0b-42e9599962bf",
            robotId: "019a2bdf-0c41-79c6-9ba3-44a62ff797a1",
            workspaceId: "f69325b3-39ee-43f8-928b-e91dfb205561"
        };
        
        // Sample data for fallback
        const sampleDoctorsData = {
            mashhad: [
                {
                    name: "دکتر مریم حسینی",
                    specialty: "چشم‌پزشک و متخصص گلوکوم",
                    address: "مشهد، خیابان امام رضا، کلینیک تخصصی نور",
                    availableTime: "دوشنبه 9:00 صبح",
                    phone: "+98-51-33445566"
                },
                {
                    name: "دکتر حسن کریمی",
                    specialty: "جراح پلاستیک چشم",
                    address: "مشهد، بلوار وکیل آباد، کلینیک چشم",
                    availableTime: "چهارشنبه 3:30 عصر",
                    phone: "+98-51-77889900"
                }
            ]
        };

        // Call Browse.ai API
        async function callBrowseAI(city) {
            try {
                console.log(`🚀 Starting Browse.ai search for Mashhad ophthalmologists...`);
                
                const response = await fetch(`https://api.browse.ai/v2/robots/${BROWSE_AI_CONFIG.robotId}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${BROWSE_AI_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputParameters: {
                            originUrl: "https://doctoreto.com/doctors/speciality/ophthalmologist/city/mashhad",
                            count: "20"
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📊 API Result:', result);
                
                const taskId = result.result?.id || result.id;
                if (!taskId) {
                    throw new Error('No task ID received');
                }
                
                return await waitForTaskCompletion(taskId);
                
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Wait for task completion
        async function waitForTaskCompletion(taskId) {
            for (let i = 0; i < 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const response = await fetch(`https://api.browse.ai/v2/robots/${BROWSE_AI_CONFIG.robotId}/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${BROWSE_AI_CONFIG.apiKey}`
                    }
                });
                
                const result = await response.json();
                console.log(`Attempt ${i + 1}:`, result);
                
                if (result.result?.status === 'successful') {
                    return result;
                }
            }
            
            throw new Error('Task timeout');
        }
        
        // Process API data
        function processApiData(apiResult) {
            try {
                console.log('🔍 Processing API Result:', JSON.stringify(apiResult, null, 2));
                
                if (!apiResult) {
                    console.log('❌ No API result provided');
                    return [];
                }
                
                const possibleDataLocations = [
                    apiResult.result?.capturedLists,
                    apiResult.result?.outputParameters,
                    apiResult.result?.capturedTexts,
                    apiResult.result?.data,
                    apiResult.capturedLists,
                    apiResult.outputParameters,
                    apiResult.data,
                    apiResult.result
                ];
                
                let capturedData = null;
                
                for (const location of possibleDataLocations) {
                    if (Array.isArray(location) && location.length > 0) {
                        capturedData = location;
                        console.log('✅ Found array data at location:', capturedData);
                        break;
                    }
                }
                
                if (!capturedData) {
                    for (const location of possibleDataLocations) {
                        if (location && typeof location === 'object' && !Array.isArray(location)) {
                            Object.keys(location).forEach(key => {
                                if (Array.isArray(location[key]) && location[key].length > 0) {
                                    capturedData = location[key];
                                    console.log(`✅ Found array data in key "${key}":`, capturedData);
                                }
                            });
                            if (capturedData) break;
                        }
                    }
                }
                
                if (!capturedData || !Array.isArray(capturedData)) {
                    console.log('❌ No valid array data found in API response');
                    return [];
                }
                
                const doctors = [];
                
                capturedData.forEach((item, index) => {
                    if (item && typeof item === 'object') {
                        const doctorData = typeof item === 'string' ? { name: item } : item;
                        
                        doctors.push({
                            name: doctorData['Doctor Name'] || 
                                  doctorData['نام دکتر'] || 
                                  doctorData.name || 
                                  doctorData.title ||
                                  `دکتر ${index + 1}`,
                            specialty: doctorData['Specialty'] || 
                                      doctorData['تخصص'] || 
                                      doctorData.specialty || 
                                      'چشم‌پزشک',
                            address: doctorData['Address'] || 
                                    doctorData['آدرس'] || 
                                    doctorData.address || 
                                    doctorData.location ||
                                    'آدرس موجود نیست',
                            availableTime: doctorData['Next Available Appointment'] || 
                                          doctorData['زمان ملاقات'] || 
                                          doctorData.availableTime || 
                                          doctorData.appointment ||
                                          'تماس بگیرید',
                            rating: doctorData['Rating'] || 
                                   doctorData['امتیاز'] || 
                                   doctorData.rating || 
                                   doctorData.score || '',
                            recommendation: doctorData['User Recommendation'] || 
                                           doctorData['پیشنهاد کاربران'] || 
                                           doctorData.recommendation || '',
                            appointments: doctorData['Successful Appointments'] || 
                                         doctorData.appointments || '',
                            profileImage: doctorData['Profile Image'] || 
                                         doctorData['تصویر پروفایل'] || 
                                         doctorData.profileImage || 
                                         doctorData.image || '',
                            profileLink: doctorData['Profile Link'] || 
                                        doctorData['لینک پروفایل'] || 
                                        doctorData.profileLink || 
                                        doctorData.link || '',
                            phone: doctorData.phone || 
                                  doctorData.contact || 
                                  doctorData.telephone ||
                                  'تلفن موجود نیست'
                        });
                    } else if (typeof item === 'string') {
                        doctors.push({
                            name: item,
                            specialty: 'چشم‌پزشک',
                            address: 'آدرس موجود نیست',
                            availableTime: 'تماس بگیرید',
                            rating: '',
                            recommendation: '',
                            appointments: '',
                            profileImage: '',
                            profileLink: '',
                            phone: 'تلفن موجود نیست'
                        });
                    }
                });
                
                console.log(`✅ Successfully processed ${doctors.length} doctors from API data`);
                return doctors;
            } catch (error) {
                console.error('❌ Error processing API data:', error);
                return [];
            }
        }
        
        // Show message
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 300px;
                ${type === 'success' ? 'background: #28a745;' : 
                  type === 'error' ? 'background: #dc3545;' : 
                  'background: #17a2b8;'}
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        async function searchDoctors() {
            const citySelect = document.getElementById('citySelect');
            const selectedCity = citySelect.value;
            const resultsSection = document.getElementById('resultsSection');
            const resultsTitle = document.getElementById('resultsTitle');
            const doctorsContainer = document.getElementById('doctorsContainer');
            const dataSource = document.getElementById('dataSource');
            const searchBtn = document.getElementById('searchBtn');
            
            if (!selectedCity) {
                showMessage('لطفاً ابتدا شهری را انتخاب کنید', 'error');
                return;
            }
            
            resultsSection.style.display = 'block';
            resultsTitle.textContent = `چشم‌پزشکان ${getCityName(selectedCity)}`;
            
            doctorsContainer.innerHTML = '<div class="loading">در حال جستجوی دکترها...</div>';
            dataSource.innerHTML = '';
            searchBtn.disabled = true;
            searchBtn.textContent = 'در حال جستجو...';
            
            let doctors = [];
            let usingApiData = false;
            
            try {
                showMessage('اتصال به Browse.ai...', 'info');
                const apiResult = await callBrowseAI(selectedCity);
                doctors = processApiData(apiResult);
                
                if (doctors.length > 0) {
                    usingApiData = true;
                    showMessage('داده‌ها با موفقیت از Browse.ai دریافت شد!', 'success');
                } else {
                    throw new Error('No data returned from API');
                }
            } catch (error) {
                console.error('API Error:', error);
                showMessage('API در دسترس نیست، از داده‌های نمونه استفاده می‌شود', 'error');
                
                doctors = sampleDoctorsData[selectedCity] || [];
            }
            
            searchBtn.disabled = false;
            searchBtn.textContent = 'جستجوی چشم‌پزشکان مشهد';
            
            displayDoctors(doctors, usingApiData, selectedCity);
        }
        
        function displayDoctors(doctors, usingApiData, city) {
            const doctorsContainer = document.getElementById('doctorsContainer');
            const dataSource = document.getElementById('dataSource');
            
            if (usingApiData) {
                dataSource.innerHTML = 'داده‌های زنده از Browse.ai';
                dataSource.className = 'data-source api';
            } else {
                dataSource.innerHTML = 'داده‌های نمونه (API در دسترس نیست)';
                dataSource.className = 'data-source sample';
            }
            
            if (doctors.length === 0) {
                doctorsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>هیچ چشم‌پزشکی در این شهر یافت نشد</h3>
                        <p>لطفاً شهر دیگری را انتخاب کنید یا بعداً دوباره تلاش کنید</p>
                    </div>
                `;
                return;
            }
            
            const doctorsHTML = doctors.map(doctor => `
                <div class="doctor-card">
                    <div class="doctor-header">
                        ${doctor.profileImage ? `<img src="${doctor.profileImage}" alt="${doctor.name}" class="doctor-image" onerror="this.style.display='none'">` : ''}
                        <div class="doctor-name-section">
                            <div class="doctor-name">${doctor.name}</div>
                            ${doctor.rating ? `<div class="doctor-rating">⭐ ${doctor.rating}</div>` : ''}
                        </div>
                    </div>
                    <div class="doctor-info">
                        <div class="info-item">
                            <span class="info-icon">🎓</span>
                            <span class="specialty">${doctor.specialty}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">🏥</span>
                            <span class="info-text">${doctor.address}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">⏰</span>
                            <div class="available-time">${doctor.availableTime}</div>
                        </div>
                        ${doctor.recommendation ? `
                        <div class="info-item">
                            <span class="info-icon">👍</span>
                            <span class="info-text">${doctor.recommendation}</span>
                        </div>
                        ` : ''}
                        ${doctor.appointments ? `
                        <div class="info-item">
                            <span class="info-icon">📅</span>
                            <span class="info-text">${doctor.appointments}</span>
                        </div>
                        ` : ''}
                        ${doctor.profileLink ? `
                        <div class="info-item">
                            <span class="info-icon">🔗</span>
                            <a href="${doctor.profileLink}" target="_blank" rel="noopener noreferrer" class="profile-link">مشاهده پروفایل در دکترتو</a>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            doctorsContainer.innerHTML = doctorsHTML;
        }
        
        function getCityName(cityCode) {
            const cityNames = {
                mashhad: 'مشهد',
                tehran: 'تهران',
                isfahan: 'اصفهان',
                shiraz: 'شیراز',
                tabriz: 'تبریز',
                ahvaz: 'اهواز',
                qom: 'قم',
                karaj: 'کرج'
            };
            return cityNames[cityCode] || cityCode;
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996132e043171e62',t:'MTc2MTcyNTQ1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>